<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>Multi-Player Streaming Example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- hls.js -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <!-- JWPlayer (demo library) -->
    <script src="https://cdn.jwplayer.com/libraries/IDzF9Zmk.js"></script>
    <!-- video.js -->
    <link href="https://vjs.zencdn.net/7.8.4/video-js.css" rel="stylesheet" />
    <script src="https://vjs.zencdn.net/7.8.4/video.js"></script>
    <!-- Clappr.js -->
    <script src="https://cdn.jsdelivr.net/npm/clappr@latest/dist/clappr.min.js"></script>
    <style>
        body {
            margin: 0;
            font-family: "Sarabun", Arial, sans-serif;
            background: #2d2d3a;
            color: #fff;
        }
        .container {
            display: flex;
            height: 100vh;
        }
        .sidebar {
            width: 300px;
            background: #9d6efd;
            padding: 0;
            overflow-y: auto;
        }
        .group {
            background: #9d6efd;
            border-bottom: 1px solid #6b4baa;
        }
        .group.active {
            background: gold;
            color: #222;
        }
        .group .title {
            padding: 20px;
            cursor: pointer;
            font-weight: bold;
        }
        .group .items {
            display: none;
            background: #8162c0;
        }
        .group.active .items {
            display: block;
        }
        .item {
            padding: 15px 20px;
            border-bottom: 1px solid #8464bd;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .item.selected {
            background: gold;
            color: #222;
        }
        .item img {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            background: #fff;
            object-fit: contain;
        }
        .main {
            flex: 1;
            background: #23223a;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .player-switch-label {
            position: absolute;
            top: 15px;
            right: 30px;
            background: #4a1875cc;
            color: #fff;
            padding: 10px 20px;
            border-radius: 10px;
            font-size: 1.1em;
            z-index: 10;
        }
        .player-selector {
            margin: 40px 0 15px 0;
            display: flex;
            gap: 10px;
        }
        .player-selector button {
            background: #4e308e;
            color: #fff;
            border: none;
            padding: 7px 18px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            outline: none;
            transition: background 0.2s;
        }
        .player-selector button.active {
            background: gold;
            color: #222;
        }
        .player-area {
            width: 80%;
            max-width: 800px;
            min-height: 420px;
            background: #222;
            border-radius: 16px;
            box-shadow: 0 2px 30px #0006;
            overflow: hidden;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .video-js {
            width: 100% !important;
            height: 420px !important;
            background: #222;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="sidebar" id="sidebar"></div>
    <div class="main">
        <div id="playerTypeLabel" class="player-switch-label">กำลังใช้ player: hls.js</div>
        <div class="player-selector" id="playerSelector">
            <button data-player="hlsjs" class="active">hls.js</button>
            <button data-player="jwplayer">JW Player</button>
            <button data-player="videojs">Video.js</button>
            <button data-player="clappr">Clappr.js</button>
        </div>
        <div class="player-area" id="playerArea">
            <!-- Player will be rendered here -->
        </div>
    </div>
</div>

<script>
const playlistUrl = "https://dl.dropbox.com/scl/fi/9zigxt0wqb2wq98gr6lns/.m3u?rlkey=mj4zehh4qqff4bqer5qlwm4vh&dl=1";
let playlistData = {}, selectedGroup = null, selectedItem = null, selectedPlayer = "hlsjs";

// ----- Parser ที่รองรับโลโก้ tvg-logo -----
function parseM3U(text) {
    const lines = text.split(/\r?\n/);
    let result = {};
    for (let i = 0; i < lines.length; ++i) {
        const line = lines[i].trim();
        if (line.startsWith("#EXTINF")) {
            let groupMatch = line.match(/group-title="(.*?)"/);
            let titleMatch = line.match(/,(.+)$/);
            let logoMatch = line.match(/tvg-logo="([^"]+)"/);
            let group = groupMatch ? groupMatch[1] : "Ungrouped";
            let title = titleMatch ? titleMatch[1] : "Unknown";
            let logo = logoMatch ? logoMatch[1] : "";
            let url = lines[i+1]?.trim();
            if (!url || url.startsWith('#')) continue;
            if (!result[group]) result[group] = [];
            result[group].push({title, url, logo});
        }
    }
    return result;
}

// ----- Sidebar Renderer (รวม logo ในช่อง) -----
function renderSidebar(groups) {
    const sidebar = document.getElementById('sidebar');
    sidebar.innerHTML = '';
    if (Object.keys(groups).length === 0) {
        sidebar.innerHTML = "<div style='padding:30px;color:#222;background:#ffea80;'>ไม่พบข้อมูลรายการ กรุณาตรวจสอบลิงก์หรือไฟล์ playlist</div>";
        return;
    }
    Object.keys(groups).forEach(group => {
        let active = (group === selectedGroup);
        let groupDiv = document.createElement('div');
        groupDiv.className = 'group' + (active ? ' active' : '');
        let groupTitle = document.createElement('div');
        groupTitle.className = 'title';
        groupTitle.textContent = group;
        groupTitle.onclick = () => {
            selectedGroup = group;
            renderSidebar(groups);
        };
        groupDiv.appendChild(groupTitle);

        let groupItems = document.createElement('div');
        groupItems.className = 'items';
        if (active) {
            groups[group].forEach(item => {
                let itemDiv = document.createElement('div');
                itemDiv.className = 'item' + (selectedItem === item ? ' selected' : '');
                // แสดง logo (ถ้ามี) ทางซ้าย
                let logoHtml = item.logo ? `<img src="${item.logo}" alt="logo">` : "";
                itemDiv.innerHTML = logoHtml + `<span>${item.title}</span>`;
                itemDiv.onclick = () => {
                    selectedItem = item;
                    renderSidebar(groups);
                    playVideo(item.url);
                };
                groupItems.appendChild(itemDiv);
            });
        }
        groupDiv.appendChild(groupItems);
        sidebar.appendChild(groupDiv);
    });
}

// ----- Player Renderers -----
function renderPlayer(url) {
    const area = document.getElementById('playerArea');
    area.innerHTML = '';
    switch(selectedPlayer) {
        case "hlsjs":
            let video = document.createElement('video');
            video.id = "hls-player";
            video.controls = true;
            video.width = 800;
            video.height = 420;
            area.appendChild(video);
            if(Hls.isSupported()) {
                let hls = new Hls();
                hls.loadSource(url);
                hls.attachMedia(video);
            } else if(video.canPlayType('application/vnd.apple.mpegurl')) {
                video.src = url;
            }
            break;
        case "jwplayer":
            let jwDiv = document.createElement('div');
            jwDiv.id = 'jwplayerDiv';
            area.appendChild(jwDiv);
            jwplayer('jwplayerDiv').setup({
                file: url,
                width: '100%',
                aspectratio: '16:9'
            });
            break;
        case "videojs":
            area.innerHTML = '<video-js id="videojs-player" class="video-js vjs-default-skin" controls preload="auto" width="800" height="420"></video-js>';
            videojs('videojs-player', {sources: [{src:url,type:"application/x-mpegURL"}]});
            break;
        case "clappr":
            area.innerHTML = '<div id="clappr-player"></div>';
            const clapprPlayer = new Clappr.Player({
                source: url,
                parentId: "#clappr-player",
                width: "100%",
                height: 420,
                autoPlay: false,
            });
            break;
    }
    showPlayerTypeLabel();
}

// ----- UI Label -----
function showPlayerTypeLabel() {
    const label = document.getElementById("playerTypeLabel");
    const names = {
        hlsjs: "hls.js",
        jwplayer: "JW Player",
        videojs: "Video.js",
        clappr: "Clappr.js"
    };
    label.textContent = "กำลังใช้ player: " + names[selectedPlayer];
}

// ----- Loader/แจ้งเตือน -----
function playVideo(url) {
    if(!url) {
        document.getElementById('playerArea').innerHTML = "<div style='color:#fff;padding:30px;'>กรุณาเลือกช่องเพื่อแสดงรายการ</div>";
        return;
    }
    renderPlayer(url);
}

// ----- Player selection -----
document.getElementById("playerSelector").addEventListener("click", function(e) {
    if(e.target.tagName === "BUTTON") {
        selectedPlayer = e.target.getAttribute("data-player");
        [...document.querySelectorAll(".player-selector button")].forEach(btn => btn.classList.remove("active"));
        e.target.classList.add("active");
        showPlayerTypeLabel();
        if(selectedItem) playVideo(selectedItem.url);
    }
});

// ----- โหลด playlist -----
fetch(playlistUrl)
    .then(resp => {
        if(!resp.ok) throw new Error("Playlist fetch failed");
        return resp.text();
    })
    .then(text => {
        playlistData = parseM3U(text);
        const groupsArray = Object.keys(playlistData);
        if (groupsArray.length) {
            selectedGroup = groupsArray[0];
            selectedItem = playlistData[selectedGroup][0];
        }
        renderSidebar(playlistData);
        playVideo(selectedItem ? selectedItem.url : null);
    })
    .catch(err => {
        document.getElementById('sidebar').innerHTML = "<div style='padding:30px;color:#222;background:#ffea80;'>โหลด playlist ไม่สำเร็จ (" + err.message + ")</div>";
        document.getElementById('playerArea').innerHTML = "<div style='color:#fff;padding:30px;'>ไม่สามารถโหลดรายการ</div>";
    });
</script>
</body>
</html>
